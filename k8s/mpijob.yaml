apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  name: matrix-multiplication-mpijob
  labels:
    app: distribiuted-matrix-multiplication
spec:
  launcherCreationPolicy: WaitForWorkersReady
  slotsPerWorker: 1
  runLauncherAsWorker: false
  runPolicy:
    cleanPodPolicy: None
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      template:
        metadata:
          labels:
            app: distribiuted-matrix-multiplication
            role: launcher
        spec:
          restartPolicy: Never
          containers:
          - name: launcher
            image: distribiuted-matrix-multiplication:latest
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - |
              set -e
              WORKER_COUNT=${WORKER_COUNT:-4}
              
              # Sprawdzenie WORKER_COUNT
              if [ "$WORKER_COUNT" -lt 1 ]; then
                echo "BŁĄD: WORKER_COUNT musi być >= 1, otrzymano: $WORKER_COUNT"
                exit 1
              fi
              
              if [ ! -s /etc/mpi/hostfile ]; then
                echo "BŁĄD: /etc/mpi/hostfile nie istnieje lub jest pusty"
                exit 1
              fi

              MATRIX_A=/matrix-data/matrix_a.txt
              MATRIX_B=/matrix-data/matrix_b.txt
              OUTPUT=/result-data/output.txt
              TOTAL_PROCS=$((WORKER_COUNT + 1))
              POD_INTERFACE="eth0"
              ORDERED_HOSTFILE=/tmp/hostfile-ordered
              LAUNCHER_HOST=$(hostname)
              cat /etc/mpi/hostfile
              echo "[Launcher] Nazwa hosta: ${LAUNCHER_HOST}"
              echo "${LAUNCHER_HOST} slots=1" > "$ORDERED_HOSTFILE"
              cat /etc/mpi/hostfile >> "$ORDERED_HOSTFILE"

              mpirun -np $TOTAL_PROCS \
                --allow-run-as-root \
                --oversubscribe \
                --hostfile "$ORDERED_HOSTFILE" \
                --mca orte_base_help_aggregate 0 \
                --mca plm_rsh_args "-o ConnectionAttempts=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
                --mca btl_vader_single_copy_mechanism none \
                --mca routed direct \
                --mca oob tcp \
                --mca btl "^openib" \
                --mca btl_tcp_port_min_v4 20000 \
                --mca btl_tcp_port_max_v4 30000 \
                -x OMPI_MCA_routed=direct \
                -x OMPI_MCA_oob=tcp \
                /app/distribiuted-matrix-multiplication \
                "$MATRIX_A" "$MATRIX_B" "$OUTPUT"
              
              echo "MPI zakończone. Wynik zapisany do $OUTPUT"
            envFrom:
            - configMapRef:
                name: mpi-env-config
            env:
            - name: WORKER_COUNT
              value: "${WORKER_COUNT}"
            volumeMounts:
            - name: matrix-data
              mountPath: /matrix-data
              readOnly: true
            - name: matrix-output
              mountPath: /result-data
            resources:
              requests:
                memory: "256Mi"
                cpu: "200m"
              limits:
                memory: "4Gi"
                cpu: "4"
          volumes:
          - name: matrix-data
            configMap:
              name: matrix-data-config
          - name: matrix-output
            persistentVolumeClaim:
              claimName: matrix-storage
    Worker:
      replicas: ${WORKER_COUNT}
      template:
        metadata:
          labels:
            app: distribiuted-matrix-multiplication
            role: worker
        spec:
          restartPolicy: Never
          containers:
          - name: worker
            image: distribiuted-matrix-multiplication:latest
            imagePullPolicy: IfNotPresent
            command: ["/bin/sh", "-c", "/usr/sbin/sshd -D"]
            envFrom:
            - configMapRef:
                name: mpi-env-config
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "4Gi"
                cpu: "1"
